{"version":3,"file":"me.js","sourceRoot":"","sources":["../../src/handlers/me.ts"],"names":[],"mappings":"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","sourcesContent":["import { KVNamespace } from '@cloudflare/workers-types'\nimport { ProviderRegistry } from '../types/provider'\nimport { SessionRecord } from '../types/session'\nimport { randomBytesBase64Url } from '../utils/pkce'\nimport { jsonWithCors } from '../utils/response'\n\nasync function authnFromHeader(request: Request, env: { SESSIONS: KVNamespace }) {\n  const m = (request.headers.get('authorization') || '').match(/^Bearer\\s+(.+)$/i)\n  if (!m) return null\n  const sessionId = m[1]\n  const key = `sess:${sessionId}`\n  const rec = await env.SESSIONS.get(key)\n  if (!rec) return null\n  return { sessionId, key, recordJson: rec, record: JSON.parse(rec) as SessionRecord }\n}\n\n/**\n * GET /me\n * - 현재 로그인 사용자 정보 반환\n * - ?refresh=1 또는 x-refresh-userinfo: 1 → provider의 userinfo를 다시 조회 후 저장\n * - ?rotate=1 → 새 세션ID 발급(헤더 x-session-rotate)\n */\nexport async function oauth2Me(\n  request: Request,\n  env: { SESSIONS: KVNamespace<string> },\n  providers: ProviderRegistry\n): Promise<Response> {\n  const authn = await authnFromHeader(request, env)\n  if (!authn) return jsonWithCors({ error: 'Unauthorized' }, 401)\n\n  const url = new URL(request.url)\n  const wantRefresh = url.searchParams.get('refresh') === '1' ||\n    request.headers.get('x-refresh-userinfo') === '1'\n  const wantRotate = url.searchParams.get('rotate') === '1'\n\n  const session = authn.record\n  const providerKey = session.provider\n  const cfg = providers[providerKey]\n\n  // userinfo 갱신\n  if (wantRefresh && cfg?.userinfo_url && session.token?.access_token) {\n    try {\n      const ui = await fetch(cfg.userinfo_url, {\n        headers: { Authorization: `Bearer ${session.token.access_token}`, accept: 'application/json' }\n      })\n      if (ui.ok) {\n        session.user = await ui.json()\n      }\n    } catch (_) {\n      // userinfo 실패는 전체 요청 실패로 보지 않음\n    }\n  }\n\n  // 롤링 TTL 적용\n  const ttlSeconds = 7 * 24 * 60 * 60 // 7 days\n  let sessionKey = authn.key\n  let sessionId = authn.sessionId\n\n  // 세션 회전\n  if (wantRotate) {\n    const newId = randomBytesBase64Url(48)\n    const newKey = `sess:${newId}`\n    await env.SESSIONS.put(newKey, JSON.stringify(session), { expirationTtl: ttlSeconds })\n    await env.SESSIONS.delete(sessionKey)\n    sessionKey = newKey\n    sessionId = newId\n    // 헤더로 회전 사실 알림\n    const res = jsonWithCors(\n      {\n        ok: true,\n        user: session.user ?? null,\n        provider: providerKey,\n        token_expires_in: session.token?.expires_in ?? null,\n      },\n      200\n    )\n    const h = new Headers(res.headers)\n    h.set('x-session-rotate', sessionId)\n    // 새 TTL로 롤링\n    return new Response(res.body, { status: res.status, headers: h })\n  } else {\n    // 회전 없이 롤링 TTL만 갱신\n    await env.SESSIONS.put(sessionKey, JSON.stringify(session), { expirationTtl: ttlSeconds })\n  }\n\n  return jsonWithCors({\n    ok: true,\n    user: session.user ?? null,\n    provider: providerKey,\n    token_expires_in: session.token?.expires_in ?? null,\n  })\n}\n"]}
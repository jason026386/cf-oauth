{"version":3,"file":"login.js","sourceRoot":"","sources":["../../src/handlers/login.ts"],"names":[],"mappings":"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","sourcesContent":["import { crypto, CryptoKey, fetch, JsonWebKey, KVNamespace } from '@cloudflare/workers-types'\nimport { OAuth2ProviderConfig, ProviderRegistry } from '../types/provider'\nimport { SessionRecord } from '../types/session'\nimport { randomBytesBase64Url } from '../utils/pkce'\nimport { jsonWithCors } from '../utils/response'\n\ntype IDTokenPayload = {\n  iss: string\n  aud: string | string[]\n  sub: string\n  iat: number // seconds\n  exp: number // seconds\n  nonce?: string\n  email?: string\n  email_verified?: boolean\n  name?: string\n  picture?: string\n}\n\ntype JoseJwk = JsonWebKey & {\n  kid?: string\n  x5c?: string[]\n  x5t?: string\n  'x5t#S256'?: string\n}\n\ntype JwksResponse = { keys: JoseJwk[] }\n\nconst b64urlToUint8 = (b64url: string): Uint8Array => {\n  // base64url → base64\n  const padLen = (4 - (b64url.length % 4)) % 4\n  const base64 = b64url.replace(/-/g, '+').replace(/_/g, '/') + '='.repeat(padLen)\n  const bin = atob(base64)\n  const out = new Uint8Array(bin.length)\n  for (let i = 0; i < bin.length; i++) out[i] = bin.charCodeAt(i)\n  return out\n}\n\nconst enc = new TextEncoder()\n\nfunction parseJwt(idToken: string) {\n  const parts = idToken.split('.')\n  if (parts.length !== 3) throw new Error('invalid_jwt')\n  const [h, p, s] = parts\n  const header = JSON.parse(new TextDecoder().decode(b64urlToUint8(h))) as { alg: string; kid?: string; kty?: string }\n  const payload = JSON.parse(new TextDecoder().decode(b64urlToUint8(p))) as IDTokenPayload\n  const signature = b64urlToUint8(s)\n  const signingInput = enc.encode(`${h}.${p}`)\n  return { header, payload, signature, signingInput }\n}\n\nasync function fetchDiscovery(discovery: string) {\n  const r = await fetch(discovery, { headers: { accept: 'application/json' } })\n  if (!r.ok) throw new Error('discovery_failed')\n  return r.json() as any\n}\n\n// JwksResponse로 맞춤 + Cloudflare 캐시 힌트\nasync function fetchJWKS(jwksUri: string): Promise<JwksResponse> {\n  const r = await fetch(jwksUri, { headers: { accept: 'application/json' }, cf: { cacheTtl: 300 } as any })\n  if (!r.ok) throw new Error('jwks_failed')\n  return r.json() as Promise<JwksResponse>\n}\n\nasync function getJWKS(cfg: OAuth2ProviderConfig): Promise<JwksResponse> {\n  const o = cfg.oidc\n  if (!o) throw new Error('no_oidc_config')\n  if (o.jwks_uri) return fetchJWKS(o.jwks_uri)\n  if (!o.discovery) throw new Error('no_discovery_or_jwks')\n  const disc = await fetchDiscovery(o.discovery)\n  return fetchJWKS(disc.jwks_uri as string)\n}\n\n// kid 우선, 없으면 alg + kty/crv까지 보수적으로 매칭\nfunction pickJwkForHeader(jwks: JwksResponse, header: { alg: string; kid?: string }): JoseJwk {\n  if (header.kid) {\n    const found = jwks.keys.find(k => k.kid === header.kid)\n    if (found) return found\n  }\n  const alg = header.alg\n  if (!alg) throw new Error('missing_alg')\n  // RS256 → kty: \"RSA\", ES256 → kty: \"EC\", crv: \"P-256\"\n  const isRS = alg === 'RS256'\n  const isES = alg === 'ES256'\n  const found = jwks.keys.find(k => {\n    if (isRS) return (k.kty === 'RSA') && (!k.alg || k.alg === 'RS256')\n    if (isES) return (k.kty === 'EC') && (k.crv === 'P-256') && (!k.alg || k.alg === 'ES256')\n    return false\n  })\n  if (!found) throw new Error('jwk_not_found')\n  return found\n}\n\nasync function importVerifyKey(jwk: JoseJwk, alg: string): Promise<CryptoKey> {\n  if (alg === 'RS256') {\n    return crypto.subtle.importKey('jwk', jwk, { name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-256' }, false, ['verify'])\n  }\n  if (alg === 'ES256') {\n    return crypto.subtle.importKey('jwk', jwk, { name: 'ECDSA', namedCurve: 'P-256' }, false, ['verify'])\n  }\n  throw new Error(`unsupported_alg:${alg}`)\n}\n\nasync function verifySignature(\n  header: { alg: string; kid?: string },\n  signature: Uint8Array,\n  signingInput: Uint8Array,\n  jwks: JwksResponse\n) {\n  const jwk = pickJwkForHeader(jwks, header)\n  const key = await importVerifyKey(jwk, header.alg)\n  if (header.alg === 'RS256') {\n    return crypto.subtle.verify('RSASSA-PKCS1-v1_5', key, signature, signingInput)\n  }\n  if (header.alg === 'ES256') {\n    return crypto.subtle.verify({ name: 'ECDSA', hash: 'SHA-256' }, key, signature, signingInput)\n  }\n  throw new Error(`unsupported_alg:${header.alg}`)\n}\n\nfunction assertClaims(payload: IDTokenPayload, cfg: OAuth2ProviderConfig, nonce?: string) {\n  const o = cfg.oidc!\n  const now = Math.floor(Date.now() / 1000)\n\n  // iss\n  if (payload.iss !== o.issuer) throw new Error('invalid_iss')\n\n  // aud\n  const auds = Array.isArray(payload.aud) ? payload.aud : [payload.aud]\n  const okAud =\n    auds.includes(cfg.client_id) ||\n    (o.acceptable_audiences ?? []).some(a => auds.includes(a))\n  if (!okAud) throw new Error('invalid_aud')\n\n  // exp/iat (±5m)\n  if (payload.exp < now - 300) throw new Error('expired')\n  if (payload.iat > now + 300) throw new Error('iat_in_future')\n\n  // nonce\n  if (nonce && payload.nonce !== nonce) throw new Error('nonce_mismatch')\n\n  if (o.require_email_verified && payload.email && payload.email_verified === false) {\n    throw new Error('email_not_verified')\n  }\n}\n\nexport async function oauth2Login(\n  request: Request,\n  env: { SESSIONS: KVNamespace },\n  providers: ProviderRegistry,\n  providerKey: string\n): Promise<Response> {\n  if (request.method !== 'POST') return jsonWithCors({ error: 'method_not_allowed' }, 405)\n\n  const cfg = providers[providerKey]\n  if (!cfg?.oidc) return jsonWithCors({ error: 'unknown_or_non_oidc_provider', provider: providerKey }, 400)\n\n  let body: any\n  try {\n    body = await request.json()\n  } catch {\n    return jsonWithCors({ error: 'invalid_json' }, 400)\n  }\n  const idToken = body?.idToken as string | undefined\n  const nonce = body?.nonce as string | undefined\n  if (!idToken) return jsonWithCors({ error: 'missing_idToken' }, 400)\n  if (!nonce) return jsonWithCors({ error: 'missing_nonce' }, 400)\n\n  try {\n    // 1) JWT 파싱\n    const { header, payload, signature, signingInput } = parseJwt(idToken)\n\n    // 2) JWKS 서명 검증\n    const jwks = await getJWKS(cfg)\n    const ok = await verifySignature(header, signature, signingInput, jwks)\n    if (!ok) throw new Error('bad_signature')\n\n    // 3) iss/aud/exp/iat/nonce 검증\n    assertClaims(payload, cfg, nonce)\n\n    // 4) 세션 발급 (기본 7일, env로 조절)\n    const ttlSeconds = 7 * 24 * 60 * 60 // 7d\n    const expiresIn = Math.max(0, payload.exp - Math.floor(Date.now() / 1000))\n\n    const sessionId = randomBytesBase64Url(48)\n    const session: SessionRecord = {\n      provider: providerKey,\n      created_at: Date.now(),\n      user: {\n        sub: payload.sub,\n        email: payload.email,\n        name: payload.name,\n        picture: payload.picture,\n        email_verified: payload.email_verified,\n      },\n      token: { id_token_hint: true, expires_in: expiresIn },\n    }\n\n    await env.SESSIONS.put(`sess:${sessionId}`, JSON.stringify(session), {\n      expirationTtl: ttlSeconds,\n    })\n\n    return jsonWithCors({ ok: true, sessionId, user: session.user, provider: providerKey })\n  } catch (e: any) {\n    // 과도한 내부 정보를 노출하지 않되, 디버깅용 detail은 남김\n    return jsonWithCors({ error: 'invalid_idToken', detail: e?.message ?? String(e) }, 401)\n  }\n}"]}
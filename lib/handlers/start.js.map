{"version":3,"file":"start.js","sourceRoot":"","sources":["../../src/handlers/start.ts"],"names":[],"mappings":"AAIA,OAAO,EAAE,SAAS,EAAE,YAAY,EAAE,oBAAoB,EAAE,MAAM,eAAe,CAAA;AAC7E,OAAO,EAAE,YAAY,EAAE,MAAM,mBAAmB,CAAA;AAEhD,uBAAuB;AACvB,kEAAkE;AAClE,yEAAyE;AACzE,MAAM,CAAC,KAAK,UAAU,WAAW,CAC/B,OAAgB,EAChB,GAA0B,EAC1B,YAAoB,EACpB,SAA2B,EAC3B,WAAmB;IAEnB,MAAM,GAAG,GAAG,IAAI,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,CAAA;IAEhC,sBAAsB;IACtB,MAAM,GAAG,GAAG,SAAS,CAAC,YAAY,CAAC,CAAA;IACnC,IAAI,CAAC,GAAG;QAAE,OAAO,YAAY,CAAC,EAAE,KAAK,EAAE,kBAAkB,EAAE,WAAW,EAAE,YAAY,EAAE,EAAE,GAAG,CAAC,CAAA;IAE5F,8BAA8B;IAC9B,MAAM,IAAI,GAAG,MAAM,YAAY,EAAE,CAAA;IACjC,MAAM,IAAI,GAAG,oBAAoB,CAAC,EAAE,CAAC,CAAA;IACrC,MAAM,KAAK,GAAG,oBAAoB,CAAC,EAAE,CAAC,CAAA;IAEtC,MAAM,YAAY,GAAiB,EAAE,CAAC,EAAE,IAAI,EAAE,CAAC,EAAE,KAAK,EAAE,CAAC,EAAE,YAAY,EAAE,EAAE,EAAE,IAAI,CAAC,GAAG,EAAE,EAAE,CAAA;IACzF,MAAM,KAAK,GAAG,SAAS,CAAC,IAAI,CAAC,SAAS,CAAC,YAAY,CAAC,CAAC,CAAA;IAErD,MAAM,GAAG,GAAc;QACrB,QAAQ,EAAE,YAAY;QACtB,aAAa,EAAE,IAAI,CAAC,QAAQ;QAC5B,IAAI;QACJ,UAAU,EAAE,IAAI,CAAC,GAAG,EAAE;QACtB,SAAS,EAAE,GAAG,CAAC,YAAY,CAAC,GAAG,CAAC,WAAW,CAAC;KAC7C,CAAA;IAED,oCAAoC;IACpC,MAAM,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,OAAO,KAAK,EAAE,EAAE,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,EAAE,EAAE,aAAa,EAAE,GAAG,EAAE,CAAC,CAAA;IAE/E,yBAAyB;IACzB,MAAM,MAAM,GAAG,IAAI,eAAe,CAAC;QACjC,aAAa,EAAE,MAAM;QACrB,SAAS,EAAE,GAAG,CAAC,SAAS;QACxB,YAAY,EAAE,WAAW;QACzB,KAAK,EAAE,GAAG,CAAC,KAAK;QAChB,cAAc,EAAE,IAAI,CAAC,SAAS;QAC9B,qBAAqB,EAAE,MAAM;QAC7B,KAAK;KACN,CAAC,CAAA;IAEF,0BAA0B;IAC1B,OAAO,QAAQ,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,QAAQ,IAAI,MAAM,CAAC,QAAQ,EAAE,EAAE,EAAE,GAAG,CAAC,CAAA;AACvE,CAAC","sourcesContent":["import { KVNamespace } from '@cloudflare/workers-types'\nimport { ProviderRegistry } from '../types/provider'\nimport { StatePayload } from '../types/state'\nimport { TxnRecord } from '../types/txn'\nimport { base64url, makePkcePair, randomBytesBase64Url } from '../utils/pkce'\nimport { jsonWithCors } from '../utils/response'\n\n// --- The Function ---\n// Redirects to the provider authorize endpoint with PKCE + state.\n// Persists TXN (code_verifier, csrf, return_to...) in KV for 10 minutes.\nexport async function oauth2Start(\n  request: Request,\n  env: { TXNS: KVNamespace },\n  providerName: string,\n  providers: ProviderRegistry,\n  redirectUri: string\n): Promise<Response> {\n  const url = new URL(request.url)\n\n  // 1) Resolve provider\n  const cfg = providers[providerName]\n  if (!cfg) return jsonWithCors({ error: 'Unknown provider', providerKey: providerName }, 400)\n\n  // 2) Create PKCE + CSRF + TXN\n  const pkce = await makePkcePair()\n  const csrf = randomBytesBase64Url(32)\n  const txnId = randomBytesBase64Url(32)\n\n  const statePayload: StatePayload = { s: csrf, t: txnId, p: providerName, ts: Date.now() }\n  const state = base64url(JSON.stringify(statePayload))\n\n  const txn: TxnRecord = {\n    provider: providerName,\n    code_verifier: pkce.verifier,\n    csrf,\n    created_at: Date.now(),\n    return_to: url.searchParams.get('return_to'),\n  }\n\n  // 3) Persist TXN to KV (TTL: 10min)\n  await env.TXNS.put(`txn:${txnId}`, JSON.stringify(txn), { expirationTtl: 600 })\n\n  // 4) Build authorize URL\n  const params = new URLSearchParams({\n    response_type: 'code',\n    client_id: cfg.client_id,\n    redirect_uri: redirectUri,\n    scope: cfg.scope,\n    code_challenge: pkce.challenge,\n    code_challenge_method: 'S256',\n    state,\n  })\n\n  // 5) Redirect to provider\n  return Response.redirect(`${cfg.auth_url}?${params.toString()}`, 302)\n}\n"]}
{"version":3,"file":"pkce.js","sourceRoot":"","sources":["../../src/utils/pkce.ts"],"names":[],"mappings":"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","sourcesContent":["export function base64url(buf: ArrayBuffer | Uint8Array | string) {\n  const bin =\n    typeof buf === 'string'\n      ? btoa(buf)\n      : btoa(String.fromCharCode(...(buf instanceof Uint8Array ? buf : new Uint8Array(buf))))\n  return bin.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/g, '')\n}\n\nexport function randomBytesBase64Url(n = 32) {\n  const a = new Uint8Array(n)\n  crypto.getRandomValues(a)\n  return base64url(a)\n}\n\nasync function sha256(input: string) {\n  const enc = new TextEncoder().encode(input)\n  const digest = await crypto.subtle.digest('SHA-256', enc)\n  return new Uint8Array(digest)\n}\n\nexport async function makePkcePair() {\n  const verifier = randomBytesBase64Url(64)\n  const challenge = base64url(await sha256(verifier))\n  return { verifier, challenge, method: 'S256' as const }\n}\n\nexport function fromBase64UrlToJSON<T = unknown>(s: string): T {\n  return JSON.parse(atob(s.replace(/-/g, '+').replace(/_/g, '/')))\n}\n\n// Cloudflare Workers의 SubtleCrypto + JOSE 없이 순정 WebCrypto로 ES256 서명 예시\nexport async function makeAppleClientSecret({\n  teamId, keyId, clientId, privateKeyPem, expSec = 3000\n}: {\n  teamId: string\n  keyId: string\n  clientId: string\n  privateKeyPem: string // -----BEGIN PRIVATE KEY----- ... -----END PRIVATE KEY-----\n  expSec?: number\n}) {\n  const header = { alg: 'ES256', kid: keyId, typ: 'JWT' }\n  const now = Math.floor(Date.now() / 1000)\n  const payload = {\n    iss: teamId,\n    iat: now,\n    exp: now + expSec,\n    aud: 'https://appleid.apple.com',\n    sub: clientId,\n  }\n  const enc = (obj: any) => btoa(JSON.stringify(obj)).replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/g, '')\n  const data = `${enc(header)}.${enc(payload)}`\n\n  // PEM → PKCS8 → CryptoKey\n  const pkcs8 = atob(privateKeyPem.replace(/-----.*KEY-----/g, '').replace(/\\s+/g, ''))\n  const keyData = Uint8Array.from(pkcs8, c => c.charCodeAt(0)).buffer\n  const key = await crypto.subtle.importKey(\n    'pkcs8', keyData, { name: 'ECDSA', namedCurve: 'P-256' }, false, ['sign']\n  )\n\n  const sigBuf = await crypto.subtle.sign({ name: 'ECDSA', hash: 'SHA-256' }, key, new TextEncoder().encode(data))\n  // DER → R|S concat(64) 변환이 필요하지만, CF WebCrypto는 DER이 아니라 RAW 시그니처를 반환함.\n  // 환경에 따라 DER일 수 있으니, 필요 시 변환 로직 추가.\n  const sig = btoa(String.fromCharCode(...new Uint8Array(sigBuf))).replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/g, '')\n  return `${data}.${sig}`\n}\n"]}